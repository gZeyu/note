# 博客粉丝机制数据库设计
其实好友关系要分两种，强好友关系（你是他好友，他必须也是你好友比如QQ），和弱好友关系（你可以关注他，但他不一定关注你比如微博）， 如果是强关系那么 <1,2>与<2,1>其实是一样的，但是如果是弱的<1,2>与<2,1>就不一样了，至于要设计成什么样的，当然看需求啦！

  
  
作者：杜朋  
链接：https://www.zhihu.com/question/20216864/answer/92695981  
来源：知乎  
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。
## 四种用户关系状态
- 关注
- 粉丝
- 互关1
- 无关系

这四种状态在查询用户粉丝、关注和互关等列表、浏览用户主页的时候会用到
## 功能需求
### 基础需求
- 查询用户的关注列表
- 查询用户的粉丝列表
- 查询用户的互关列表
- 查询两个用户关系状态
- 推送关注用户动态
### 拓展需求
- 两个用户的共同关注列表
- 两个用户的共同粉丝列表
- 用户1的关注列表里都有谁关注了用户2

## 关系型数据库方案1
### 关系模式
每个用户可以关注任意多个其他用户，同时也可以被任意多个其他用户关注。这是用户实体集内部各个实体的多对多的联系，所以只需两个表：`blog_user`和`bolg_follower`
```
blog_user(id, username, ..., gmt_create, gmt_modified)
```
```
blog_follower(id, follower, followed, gmt_create, gmt_modified)
```
### 索引
在`blog_follower`表中建一个联合索引`(follower, followed)`和一个单列索引`(followed)`。查询语句执行时会依照最左前缀匹配原则，故这里省略`(follower)`索引的创建。
```sql
CREATE INDEX idx_follower_followed ON blog_follower (follower, followed)
```
```sql
CREATE INDEX idx_followed ON blog_follower (followed)
```

### 查询用户的关注列表
```sql
SELECT followed FROM blog_follower WHERE follower = user_id
```
### 查询用户的粉丝列表
```sql
SELECT follower FROM blog_follower WHERE followed = user_id
```
### 查询用户的互关列表
```sql
SELECT t1.follower
FROM   (SELECT follower
        FROM   blog_follower
        WHERE  followed = user_id) t1
       INNER JOIN blog_follower t2
               ON t1.followed = t2.follower
```
### 查询两个用户关系状态
```sql
SELECT Sum( follower = userid AND followed = user_id )
       + Sum( follower = user_id AND followed = userid )
FROM   blog_follower
```
### 两个用户的共同关注列表
```sql
SELECT t1.followed 
FROM  (SELECT followed 
       FROM   blog_follower 
       WHERE  follower = user1_id) t1 
      INNER JOIN (SELECT followed 
                  FROM   blog_follower 
                  WHERE  follower = user2_id) t2 
              ON t1.followed = t2.followed 
```
### 两个用户的共同粉丝列表
```sql
SELECT t1.follower 
FROM  (SELECT follower 
       FROM   blog_follower 
       WHERE  followed = user1_id) t1 
      INNER JOIN (SELECT follower 
                  FROM   blog_follower 
                  WHERE  followed = user2_id) t2 
              ON t1.follower = t2.follower 
```
### 用户1的关注列表里都有谁关注了用户2
```sql
SELECT t1.followed 
FROM  (SELECT followed 
       FROM   blog_follower 
       WHERE  follower = user1_id) t1 
      INNER JOIN (SELECT follower 
                  FROM   blog_follower 
                  WHERE  followed = user2_id) t2 
              ON t1.followed = t2.follower 
```	
## 参考
1. [用MySQL实现微博关注关系的方案分析](https://my.oschina.net/yonghan/blog/475588)
2. [用Redis实现微博关注关系的分析](https://www.cnblogs.com/JockChou/p/4643646.html)
3. [微博关注我、我关注你数据库该怎么设计](https://blog.csdn.net/u010098331/article/details/51445904)
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTIzNDU4ODIwMiwxNDYwNjk5MTgsMTQ3MT
AwNDAzOCwtMTgzMDMxNzM5Miw1MTI4NDk3NzYsLTc1MDA4Nzgy
MCwtMjEzMTM1NzQwLDg0MDQ5NDM4NiwtMTA0MjYyNzA2NCwxMT
g5NjE2Nzc2LC0xNTIwMzY5NzAxLDE0MzYyOTMxODYsMTcwMjA0
NjYwOCwtMTg0OTc0NzcyNiwxODMzNTQ0NjcxLC0xOTEwNjgzMj
U1LDIyOTUxODU1OCw3MjkyOTIzNDAsMTgzMDc5MTMwLC0xMzY5
NDY2MzIyXX0=
-->