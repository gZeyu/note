# 用户关系分析
## 四种用户关系状态
- 关注
- 粉丝
- 互关1
- 无关系

这四种状态在查询用户粉丝、关注和互关等列表、浏览用户主页的时候会用到
## 功能需求
### 基础需求
- 查询用户的关注列表
- 查询用户的粉丝列表
- 查询用户的互关列表
- 查询两个用户关系状态
- 推送关注用户动态
### 拓展需求
- 两个用户的共同关注列表
- 两个用户的共同粉丝列表
- 用户a的关注列表里都有谁关注了用户b

## 方案1
### 关系模式
每个用户可以关注任意多个其他用户，同时也可以被任意多个其他用户关注。这是用户实体集内部各个实体的多对多的联系，所以只需两个表：`blog_user`和`bolg_follower`
```
blog_user(id, username, ..., gmt_create, gmt_modified)
```
```
blog_follower(id, follower, followed, gmt_create, gmt_modified)
```
### 索引
在`blog_follower`表中建一个联合索引`(follower, followed)`和一个单列索引`(followed)`。查询语句执行时会依照最左前缀匹配原则，故这里省略`(follower)`索引的创建。
```sql
CREATE INDEX idx_follower_followed ON blog_follower (follower, followed)
```
```sql
CREATE INDEX idx_followed ON blog_follower (followed)
```

### 查询用户的关注列表
```sql
SELECT followed FROM blog_follower WHERE follower = user_id
```
### 查询用户的粉丝列表
```sql
SELECT follower FROM blog_follower WHERE followed = user_id
```
### 查询用户的互关列表
```sql
SELECT t1.follower
FROM   (SELECT follower
        FROM   blog_follower
        WHERE  followed = user_id) t1
       INNER JOIN blog_follower t2
               ON t1.followed = t2.follower
```
### 查询两个用户关系状态
```sql
SELECT Sum( follower = userid AND followed = user_id )
       + Sum( follower = user_id AND followed = userid )
FROM   blog_follower
```
### 两个用户的共同关注列表
```sql
SELECT t1.followed 
FROM  (SELECT followed 
       FROM   blog_follower 
       WHERE  follower = user1_id) t1 
      INNER JOIN (SELECT followed 
                  FROM   blog_follower 
                  WHERE  follower = user2_id) t2 
              ON t1.followed = t2.followed 
```
### 两个用户的共同粉丝列表
```sql
SELECT t1.followed 
FROM  (SELECT followed 
       FROM   blog_follower 
       WHERE  follower = user1_id) t1 
      INNER JOIN (SELECT followed 
                  FROM   blog_follower 
                  WHERE  follower = user2_id) t2 
              ON t1.followed = t2.followed 
```
## 参考
1. [用MySQL实现微博关注关系的方案分析](https://my.oschina.net/yonghan/blog/475588)
2. [微博关注我、我关注你数据库该怎么设计](https://blog.csdn.net/u010098331/article/details/51445904)
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTI1MTk2NDczMiwtNzUwMDg3ODIwLC0yMT
MxMzU3NDAsODQwNDk0Mzg2LC0xMDQyNjI3MDY0LDExODk2MTY3
NzYsLTE1MjAzNjk3MDEsMTQzNjI5MzE4NiwxNzAyMDQ2NjA4LC
0xODQ5NzQ3NzI2LDE4MzM1NDQ2NzEsLTE5MTA2ODMyNTUsMjI5
NTE4NTU4LDcyOTI5MjM0MCwxODMwNzkxMzAsLTEzNjk0NjYzMj
IsMTI1NDg4ODQ2MSwxOTExMzA3MDI3LDIxMzM1NDcxNzMsNTMx
OTMwNTMzXX0=
-->